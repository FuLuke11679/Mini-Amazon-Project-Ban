<!DOCTYPE html>
<html lang="en">
<head>
    <!-- head elements -->
</head>
<body>
    <!-- Home button -->
    <a href="{{ url_for('index.index') }}" style="display: inline-block; margin-bottom: 20px; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px;">Home</a>
    <h1>Search Results</h1>

    {% if search_term %}
        <h2>Currently Searching For: {{ search_term }}</h2>
    {% else %}
        <h2>Currently Searching For Any Keyword</h2>
    {% endif %}

    {% if tag %}
        <h2>Currently Browsing in Category: {{ tag }}</h2>
    {% else %}
        <h2>Browsing All Categories</h2>
    {% endif %}

    {% if subtag %}
        <h2>Currently Browsing in Subcategory: {{ subtag }}</h2>
    {% else %}
        <h2>Browsing All Subcategories</h2>
    {% endif %}

    <script>
        function updateSubtags() {
            var tag = document.getElementById('tag').value;
            var subtagSelect = document.getElementById('subtag');
            var currentSubtag = '{{ subtag }}'; // Get the current subtag from the Flask template

            // Clear the subtag select element
            subtagSelect.innerHTML = '';

            // Add an "All" option for the selected category
            var allOption = document.createElement('option');
            allOption.value = '';
            allOption.text = 'All Subcategories';
            subtagSelect.appendChild(allOption);

            if (tag !== '') {
                // Fetch and populate subtags based on the selected category
                fetch('/get-subtags?tag=' + tag)
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        data.subtags.forEach(function(subtag) {
                            var option = document.createElement('option');
                            option.value = subtag;
                            option.text = subtag;
                            if (subtag === currentSubtag) {
                                option.selected = true;
                            }
                            subtagSelect.appendChild(option);
                        });
                    });
            }
        }

        // Call the function to update subtags on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSubtags();
        }, false);
    </script>

    <!-- Include a search bar with category and subcategory selection -->
    <form action="/search" method="get">
        <input type="text" name="keyword" placeholder="Search products..." value="{{ search_term }}">

        <select name="tag" id="tag" onchange="updateSubtags()">
            <option value="">All Categories</option>
            <option value="Groceries" {% if tag == 'Groceries' %}selected{% endif %}>Groceries</option>
            <option value="Basics" {% if tag == 'Basics' %}selected{% endif %}>Basics</option>
            <option value="Music" {% if tag == 'Music' %}selected{% endif %}>Music</option>
            <option value="Books" {% if tag == 'Books' %}selected{% endif %}>Books</option>
            <option value="Tech" {% if tag == 'Tech' %}selected{% endif %}>Tech</option>
            <option value="Pharmacy" {% if tag == 'Pharmacy' %}selected{% endif %}>Pharmacy</option>
            <option value="Fashion" {% if tag == 'Fashion' %}selected{% endif %}>Fashion</option>
            <!-- ... other options ... -->
        </select>
        
        <!-- Subcategory selection -->
        <select name="subtag" id="subtag">
            <option value="">All Subcategories</option>
            <!-- Options will be populated by JavaScript -->
        </select>

        <select name="sort_order">
            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Price: Low to High</option>
            <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Price: High to Low</option>
        </select>
        
        <button type="submit">Search</button>
    </form>
    
    <!-- Displaying products in a table similar to index.html -->
    {% if products %}
    <table class='table table-hover table-bordered container'>
        <thead class="thead-dark">
            <tr>
                <th scope="col">Product ID</th>
                <th scope="col">Product Name</th>
                <th scope="col">Price</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
                <tr>
                    <th scope="row">{{ product.id }}</th>
                    <td><a href="/product/{{ product.id }}">{{ product.name }}</a></td>
                    <td>${{ product.price }}</td>
                    <td>
                        <form action="{{ url_for('wishlist.wishlist_add', product_id=product.id) }}" method="POST">
                            <input type="submit" value="Add to Wishlist"/>
                        </form>
                        <form action="{{ url_for('cart.cart_add', product_id=product.id) }}" method="POST">
                            <input type="submit" value="Add to Cart"/>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No products found matching your criteria.</p>
    {% endif %}

    </body>
    </html>
