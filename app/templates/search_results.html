<!DOCTYPE html>
<html lang="en">
<head>
    <!-- head elements -->
</head>
<body>
    <h1>Search Results</h1>

    {% if search_term %}
        <h2>Currently Searching For: {{ search_term }}</h2>
    {% else %}
        <h2>Currently Searching For Any Keyword</h2>
    {% endif %}

    {% if tag %}
        <h2>Currently Browsing in Category: {{ tag }}</h2>
    {% else %}
        <h2>Browsing All Categories</h2>
    {% endif %}

    {% if subtag %}
        <h2>Currently Browsing in Subcategory: {{ subtag }}</h2>
    {% else %}
        <h2>Browsing All Subcategories</h2>
    {% endif %}

    <script>
        function updateSubtags() {
            var tag = document.getElementById('tag').value;
            var subtagSelect = document.getElementById('subtag');
            var currentSubtag = '{{ subtag }}'; // Get the current subtag from the Flask template

            // Clear the subtag select element
            subtagSelect.innerHTML = '';

            // Add an "All" option for the selected category
            var allOption = document.createElement('option');
            allOption.value = '';
            allOption.text = 'All Subcategories';
            subtagSelect.appendChild(allOption);

            if (tag !== '') {
                // Fetch and populate subtags based on the selected category
                fetch('/get-subtags?tag=' + tag)
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        data.subtags.forEach(function(subtag) {
                            var option = document.createElement('option');
                            option.value = subtag;
                            option.text = subtag;
                            if (subtag === currentSubtag) {
                                option.selected = true;
                            }
                            subtagSelect.appendChild(option);
                        });
                    });
            }
        }

        // Call the function to update subtags on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSubtags();
        }, false);
    </script>

    <!-- Include a search bar with category and subcategory selection -->
    <form action="/search" method="get">
        <input type="text" name="keyword" placeholder="Search products..." value="{{ search_term }}">

        <select name="tag" id="tag" onchange="updateSubtags()">
            <option value="">All Categories</option>
            <option value="Groceries" {% if tag == 'Groceries' %}selected{% endif %}>Groceries</option>
            <option value="Basics" {% if tag == 'Basics' %}selected{% endif %}>Basics</option>
            <option value="Music" {% if tag == 'Music' %}selected{% endif %}>Music</option>
            <option value="Books" {% if tag == 'Books' %}selected{% endif %}>Books</option>
            <option value="Tech" {% if tag == 'Tech' %}selected{% endif %}>Tech</option>
            <option value="Pharmacy" {% if tag == 'Pharmacy' %}selected{% endif %}>Pharmacy</option>
            <option value="Fashion" {% if tag == 'Fashion' %}selected{% endif %}>Fashion</option>
            <!-- ... other options ... -->
        </select>
        
        <!-- Subcategory selection -->
        <select name="subtag" id="subtag">
            <option value="">All Subcategories</option>
            <!-- Options will be populated by JavaScript -->
        </select>

        <select name="sort_order">
            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Price: Low to High</option>
            <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Price: High to Low</option>
        </select>
        
        <button type="submit">Search</button>
    </form>

    <!-- Displaying products -->
    {% if products %}
        <div class="product-list">
            {% for product in products %}
                <div class="product">
                    <h2><a href="{{ url_for('index.product_page', product_id=product.id) }}">{{ product.name }}</a></h2>
                    <img src="{{ product.photo_url }}" alt="{{ product.name }}">
                    <p>Price: ${{ product.price }}</p>
                    <p>{{ product.longDescription }}</p>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No products found matching your criteria.</p>
    {% endif %}
</body>
</html>
